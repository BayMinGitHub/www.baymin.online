<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Greenplum数据库迁移</title>
      <link href="/2018/12/12/Greenplum%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/"/>
      <url>/2018/12/12/Greenplum%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/</url>
      
        <content type="html"><![CDATA[<p>由于之前的数据库使用年限过久，机器性能无法满足日常计算需要，因此公司最近新购入了若干服务器，并准备将数据迁移至新库中。在正式迁移之前，通过查阅相关资料，进行一次模拟迁移。</p><a id="more"></a><h4 id="1-准备"><a href="#1-准备" class="headerlink" title="1.准备"></a>1.准备</h4><p>① VMware Workstation软件</p><p>② CentOS 7.3 镜像 ( 与老服务器相同 )</p><p>③ Greenplum 4.3.7.3 安装包 ( <a href="https://network.pivotal.io/products/pivotal-gpdb/" target="_blank" rel="noopener">https://network.pivotal.io/products/pivotal-gpdb/</a> )</p><h4 id="2-安装虚拟机"><a href="#2-安装虚拟机" class="headerlink" title="2.安装虚拟机"></a>2.安装虚拟机</h4><p>修改时区，最小安装：</p><p><img src="/2018/12/12/Greenplum数据库迁移/" alt="https://img.vim-cn.com/bc/2bd07b48aa9868a53351be1e2f3eadefe17a65.png"></p><p>添加root用户密码：</p><p><img src="/2018/12/12/Greenplum数据库迁移/2.png" alt></p><p>安装完成后，修改IP地址：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/netword-scripts/ifcfg-eno***</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">PEERDNS=yes</span><br><span class="line">PEERROUTES=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_PEERDNS=yes</span><br><span class="line">IPV6_PEERROUTES=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">NAME=eno16777736</span><br><span class="line">UUID=5bed79bf-0f21-40fe-a92c-63aa29d0dbdd</span><br><span class="line">DEVICE=eno16777736</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.216.128</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.216.2</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">DNS2=8.8.8.8</span><br></pre></td></tr></table></figure><p>重启network服务，并使用ping测试是否可以连接到外网：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service network restart</span><br></pre></td></tr></table></figure><p>安装一些需要的工具：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vim net-tools ntp ed unzip</span><br></pre></td></tr></table></figure><p>设置开机时间同步脚本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rc.d/init.d/timelock.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>Startup script for timelock</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>chkconfig:345 85 15</span><br><span class="line"><span class="meta">#</span>description:timelock server</span><br><span class="line"><span class="meta">#</span>processname:timelock</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>Source function library.</span><br><span class="line">/usr/sbin/ntpdate -u ntp1.aliyun.com</span><br></pre></td></tr></table></figure><p>增加脚本的可执行权限并添加到开机启动项目中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x  /etc/rc.d/init.d/autostart.sh</span><br><span class="line">cd /etc/rc.d/init.d</span><br><span class="line">chkconfig --add autostart.sh</span><br><span class="line">chkconfig autostart.sh on</span><br></pre></td></tr></table></figure><p>修改系统内核 ( Greenplum需要 )：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc.sysctl.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kernel.shmmax = 500000000</span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">kernel.shmall = 4000000000</span><br><span class="line">kernel.sem = 250 512000 100 2048</span><br><span class="line">kernel.sysrq = 1</span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.msgmni = 2048</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.ip_forward = 0</span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 4096</span><br><span class="line">net.ipv4.conf.all.arp_filter = 1</span><br><span class="line">net.ipv4.ip_local_port_range = 1025 65535</span><br><span class="line">net.core.netdev_max_backlog = 10000</span><br><span class="line">net.core.rmem_max = 2097152</span><br><span class="line">net.core.wmem_max = 209715</span><br></pre></td></tr></table></figure><p>打开文件限制 : ( 在最后添加 )</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/security/limits.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 131072</span><br><span class="line">* hard nproc 131072</span><br></pre></td></tr></table></figure><p>创建gpadmin用户和用户组 ( 每台都需要配置 ) ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd -g 530 gpadmin</span><br><span class="line">useradd -g 530 -u530 -m -d /home/gpadmin -s /bin/bash gpadmin</span><br><span class="line">passwd gpadmin</span><br></pre></td></tr></table></figure><p>关闭防火墙：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure><h4 id="3-拷贝两份虚拟机"><a href="#3-拷贝两份虚拟机" class="headerlink" title="3.拷贝两份虚拟机"></a>3.拷贝两份虚拟机</h4><p>分别修改IP、hostname，配置hosts</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.216.128 Master master</span><br><span class="line">192.168.216.129 sdw1</span><br><span class="line">192.168.216.130 sdw2</span><br><span class="line"> </span><br><span class="line">192.168.216.138 Master_standby master_standby gp_master_standby</span><br><span class="line">192.168.216.139 sdw1_standby segment_standby segment</span><br><span class="line">192.168.216.140 sdw2_standby mirror_standby mirror</span><br></pre></td></tr></table></figure><p>重启，准备安装数据库。</p><h4 id="4-安装数据库"><a href="#4-安装数据库" class="headerlink" title="4.安装数据库"></a>4.安装数据库</h4><p>首先在Master节点上操作：</p><p>​    切换用户gpadmin，解压下载的数据库文件并运行greenplum-db-*.bin安装文件 ( 安装过程中注意数据库安装位置 )</p><p><img src="/2018/12/12/Greenplum数据库迁移/3.png" alt></p><p>创建配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir ./conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/hostlist</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Master_standby</span><br><span class="line">sdw1_standby</span><br><span class="line">sdw2_standby</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/set_host</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdw1_standby</span><br><span class="line">sdw2_standby</span><br></pre></td></tr></table></figure><p>引入Greenplum的环境变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ./greenplum-db-4.3.7.3/greenplum_path.sh</span><br></pre></td></tr></table></figure><p>交换钥匙：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpssh-exkeys -f ./conf/hostlist</span><br></pre></td></tr></table></figure><p>PS：</p><p>一个小问题 <code>socket.gaierror: [Errno -2] Name or service not known</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">原因 hosts 里没有配置 hostname 中的 IP</span><br></pre></td></tr></table></figure><p>开始安装数据库：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpseginstall -f hostlist -u gpadmin -p 123456</span><br></pre></td></tr></table></figure><fancybox><img src="/2018/12/12/Greenplum数据库迁移/4.png" alt></fancybox><p>在不同节点上创建数据目录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>gp_master_standby:</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpmaster</span><br><span class="line"><span class="meta">#</span>sdw1_standby:</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdata1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap2</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam2</span><br><span class="line"><span class="meta">#</span>sdw2_standby</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpmaster</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap2</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam2</span><br></pre></td></tr></table></figure><p>检查系统环境：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>错误暂且不管 ( 好像并没有影响 )</span><br><span class="line">gpcheck -f ./conf/hostlist -m Master_standby -s sdw2_standby</span><br></pre></td></tr></table></figure><p>编写初始化文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>数据库代号</span><br><span class="line">ARRAY_NAME="EMC Greenplum DW"</span><br><span class="line">MACHINE_LIST_FILE=/home/gpadmin/conf/seg_hosts</span><br><span class="line"><span class="meta">#</span>Segment 的名称前缀</span><br><span class="line">SEG_PREFIX=gpseg</span><br><span class="line"><span class="meta">#</span>primary segment 起始端口号</span><br><span class="line">PORT_BASE=40000</span><br><span class="line"><span class="meta">#</span>指定 primary segment 的数据目录</span><br><span class="line">declare -a DATA_DIRECTORY=(/home/gpadmin/gpdata/gpdatap1 /home/gpadmin/gpdata/gpdatap2)</span><br><span class="line">MASTER_HOSTNAME=gp_master_standby</span><br><span class="line">MASTER_DIRECTORY=/home/gpadmin/gpdata/gpmaster</span><br><span class="line">MASTER_DATA_DIRECTORY=/home/gpadmin/gpdata/gpmaster</span><br><span class="line">MASTER_PORT=5432</span><br><span class="line"><span class="meta">#</span>指定 bash 的版本</span><br><span class="line">TRUSTED_SHELL=ssh</span><br><span class="line"><span class="meta">#</span>mirror segment 起始端口号</span><br><span class="line">MIRROR_PORT_BASE=50000</span><br><span class="line"><span class="meta">#</span>primary segment 主备同步的起始端口号</span><br><span class="line">REPLICATION_PORT_BASE=41000</span><br><span class="line"><span class="meta">#</span>mirror segment 主备同步的起始端口号</span><br><span class="line">MIRROR_REPLICATION_PORT_BASE=51000</span><br><span class="line"><span class="meta">#</span>mirror segment 的数据目录</span><br><span class="line">declare -a MIRROR_DATA_DIRECTORY=(/home/gpadmin/gpdata/gpdatam1 /home/gpadmin/gpdata/gpdatam2)</span><br></pre></td></tr></table></figure><p>初始化数据库：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpinitsystem -c ./conf/gp_init_config -s sdw2_standby</span><br></pre></td></tr></table></figure><p>启动数据库 : </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpstart -a</span><br></pre></td></tr></table></figure><p>至此，数据库安装完毕，准备迁移数据。</p><h4 id="5-迁移数据库"><a href="#5-迁移数据库" class="headerlink" title="5.迁移数据库"></a>5.迁移数据库</h4><p>Greenplum数据库迁移可以使用官方自带工具gptransfer进行迁移，具体使用方法参照官网  ( <a href="https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html" target="_blank" rel="noopener">https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html</a>)</p><p>修改源数据库中配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/gpadmin/gpdata/gpmaster/gpseg-1/pg_hba.conf</span><br></pre></td></tr></table></figure><p>添加如下 ( IP范围为192.168.216.1 - 192.168.216.254 ) ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host     all     all     192.168.216.1/24    md5</span><br></pre></td></tr></table></figure><p>在源数据库中重新加载配置文件：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_reload_conf()</span><br></pre></td></tr></table></figure><p>准备打通目标数据库与源数据库之间的通道，创建映射文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/transferlist</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdw1,192.168.216.129</span><br><span class="line">sdw2,192.168.216.130</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/transhost</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sdw2_standby</span><br><span class="line">sdw1_standby</span><br><span class="line">master</span><br><span class="line">sdw1</span><br><span class="line">sdw2</span><br></pre></td></tr></table></figure><p>交换钥匙：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpssh-exkeys -f /home/gpadmin/conf/transhost</span><br></pre></td></tr></table></figure><p>开始迁移数据：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/gpadmin/greenplum-db-4.3.7.3/bin//gptransfer --source-map-file=/home/gpadmin/conf/transferlist --dest-host=192.168.216.128 --full</span><br></pre></td></tr></table></figure><fancybox><img src="/2018/12/12/Greenplum数据库迁移/5.png" alt></fancybox><p>迁移完毕：</p><fancybox><img src="/2018/12/12/Greenplum数据库迁移/6.png" alt></fancybox><p>将源数据库中的配置文件postgresql.conf和pg_hba.conf发送至目标数据库中，重启目标数据库。</p><p>至此数据库迁移完毕。</p><h4 id="参考网址"><a href="#参考网址" class="headerlink" title="参考网址"></a>参考网址</h4><p>① <a href="https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html" target="_blank" rel="noopener">https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html</a></p><p>② <a href="https://www.cnblogs.com/liuyungao/p/5689588.html" target="_blank" rel="noopener">https://www.cnblogs.com/liuyungao/p/5689588.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Greenplum </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Greenplum </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 数据迁移 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HelloWorld</title>
      <link href="/2018/05/05/HelloWorld/"/>
      <url>/2018/05/05/HelloWorld/</url>
      
        <content type="html"><![CDATA[<p>摘要测试</p><a id="more"></a><center>内容测试</center>]]></content>
      
      
      <categories>
          
          <category> 测试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 测试 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

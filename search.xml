<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Linux系统下搭建饥荒专用服务器（阿里云主机）</title>
      <link href="/2019/04/24/Linux%E7%B3%BB%E7%BB%9F%E4%B8%8B%E6%90%AD%E5%BB%BA%E9%A5%A5%E8%8D%92%E4%B8%93%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2019/04/24/Linux%E7%B3%BB%E7%BB%9F%E4%B8%8B%E6%90%AD%E5%BB%BA%E9%A5%A5%E8%8D%92%E4%B8%93%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<p>从零开始的饥荒专用服务器教程~~~</p><a id="more"></a><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>经常玩单机游戏的玩家都会知道，在联机过程中房主的网络状态和电脑性能影响着整个房间中玩家的游戏体验，在房主网络状态差或电脑性能低的时候，经常会出现卡顿，丢包甚至掉线的情况。这是由于在房主开游戏的时候，会在其电脑本地启动一个服务器端，然后玩家的游戏客户端都与这个服务器端连接，进行联机游戏，当房主电脑性能不足或者网络波动时，必定会影响整个服务器中的玩家体验。</p><h4 id="1-准备"><a href="#1-准备" class="headerlink" title="1.准备"></a>1.准备</h4><p>① 用来买云主机的 Money … ( 嗯 … 钱是很重要的 .. 不过可以考虑一下学生机 ,如果还是学生的话 )</p><p>② 一台可以上网的电脑 ( 废话 ) </p><p>③ SSH连接工具 ( 推荐Xshell,<a href="https://pan.baidu.com/s/1qe4Kz3Jj2xu-f2ct0YLA-w" target="_blank" rel="noopener">免费版</a>即可，提取码：idvz  )</p><h4 id="2-购买云主机"><a href="#2-购买云主机" class="headerlink" title="2.购买云主机"></a>2.购买云主机</h4><p>此处使用阿里云主机作为示例。</p><p>首先打开<a href="https://account.aliyun.com/login/login.htm" target="_blank" rel="noopener">阿里云官网</a>，注册…登陆…实名制之类的东西，然后打开<a href="https://ecs-buy.aliyun.com/wizard" target="_blank" rel="noopener">购买页面</a> ：</p><p>此处应有图片…. 1</p><p>地域：服务器地区尽量选择离你较近的地域，可以有效降低延迟。</p><p>实例：一定不要因为便宜而选突发性实例，这个规格的云主机每天只有2个多小时是满性能的，其他情况下都是超级卡的状态 ( 显然我是买过的…😭 )</p><p>镜像：选择CentOS 7.6 64位 ( 如果会Linux相关知识，系统可自己选择 )</p><p>存储：默认40G，完全够用了 </p><p>点击下一步，进入网络和安全组配置：</p><p>此处应有图片… 2</p><p>网络：默认</p><p>公网带宽：选择按固定带宽1M ( 多人可以考虑2M，如果用量不大可以选择按量付费，不过不确定一个月的具体流量 )</p><p>安全组：默认</p><p>点击下一步，进入系统配置：</p><p>登录凭证：选择自定义密码，输入登录密码 ( 以后可以在控制台重置密码 )</p><p>其他默认，然后确认订单，付款。</p><p>关于服务器配置的选择，贴一张官网的图：</p><p>此处应有图片…. 3</p><p>意思就是：</p><p>① 一个玩家需要8Kb/s的上传带宽 ( 云主机的宽带通常就是指的上传带宽，这个很容易满足 ) </p><p>② 一个玩家大约需要65M内存 ( 内存是需要重视的问题，通常玩饥荒都会开启两个世界：一个地上，一个地下。因此在计算内存的时候，如果你选择开启两个世界，那么这个数据需要乘上2。而且这个是指不开任何Mod的情况下，如果是大型Mod，内存占用是很可怕的。之前试过一次智能敌对，一个世界的进程能吃1G的内存 )</p><p>③ 不是很清楚它说的CPU是N/A是任意的意思么，可是实际上后期世界中的生物越来越多的情况下，CPU特别容易爆 ( 推荐安装服务器清理Mod )</p><p>④ 需要的环境</p><p>参考 : 我使用的是1核2G2M带宽的服务器 ,一年费用是1000+，在装有服务器清理Mod的情况下，正常6人玩到200多天是没什么问题的，不过在青蛙雨和蜘蛛区的时候还是会很卡。( 吐槽一下：垃圾游戏渣优化，以前弄求生之路服务器的时候，完全不需要考虑内存的问题，饥荒这种贴图游戏实在是太吃内存了…😒 )</p><h4 id="3-配置并连接云主机"><a href="#3-配置并连接云主机" class="headerlink" title="3.配置并连接云主机"></a>3.配置并连接云主机</h4><p>付款后，过一分钟左右就可以在<a href="https://ecs.console.aliyun.com/" target="_blank" rel="noopener">控制台</a>看到云主机了，显示的都是一些基本信息，记录下公网IP地址。然后按照下图进入安全组配置：</p><p>此处应用图片。。。 4</p><p>点击配置规则：( 饥荒服务器默认端口为10999和10998，因此需要开启这两个端口 )</p><p>此处应有图片… 5 </p><p>此处应有图片… 6</p><p>打开Xshell工具，使用快捷键ALT+N新建连接，如下图 ( 也可以点击 -&gt; 文件 -&gt; 新建 )：</p><p>此处应有图片… 7 </p><p>此处应有图片… 8</p><p>点击连接，下面的提示点击确定，进入下面的界面就表示连接成功：</p><p>此处应有图片… 9</p><h4 id="4-下载并安装游戏"><a href="#4-下载并安装游戏" class="headerlink" title="4.下载并安装游戏"></a>4.下载并安装游戏</h4><p>接下来就是操作Linux系统了，下面命令按行敲入窗口中，按回车键执行。</p><p>首先更新yum ( Linux系统中安装软件包的工具 ) : </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br><span class="line">yum upgrade -y</span><br></pre></td></tr></table></figure><p>安装游戏运行环境和常用工具</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install glibc.i686 libstdc++.i686 libcurl.i686 vim screen -y</span><br></pre></td></tr></table></figure><p>创建steam用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">useradd steam </span><br><span class="line">su steam</span><br><span class="line">cd ~</span><br><span class="line">mkdir steamcmd</span><br><span class="line">cd steamcmd</span><br></pre></td></tr></table></figure><p>下载并解压Steam的Linux客户端steamcmd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz</span><br><span class="line">tar -zxvf steamcmd_linux.tar.gz</span><br></pre></td></tr></table></figure><p>启动Steam客户端，并开始下载饥荒 ( 饥荒专用服务器ID为 343050 ) </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./steamcmd.sh +login anonymous +force_install_dir /home/dst +app_update 343050 validate +quit</span><br></pre></td></tr></table></figure><p>下载完毕后 ( 大概十分钟左右 )，先启动一次服务器，验证是否缺失依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /home/steam/dst/bin</span><br><span class="line">~/dst/bin/dontstarve_dedicated_server_nullrenderer -cluster MyDediServer -shard Master</span><br></pre></td></tr></table></figure><p>此时可能会报找不到libcurl-gnutls.so.4，解决方法为将该依赖库复制到饥荒游戏文件夹中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/lib/libcurl.so.4 ~/dst/bin/lib32/libcurl-gnutls.so.4</span><br></pre></td></tr></table></figure><p>这里可能会有其他依赖包的缺失问题，解决办法即是将依赖复制到饥荒游戏文件夹中。</p><p>正常启动后，按Ctrl+C即可关闭服务器，也可以使用控制台命令c_shutdown()。</p><p>PS：饥荒服务器控制台指令自行百度。</p><h4 id="5-存档配置"><a href="#5-存档配置" class="headerlink" title="5.存档配置"></a>5.存档配置</h4><p>在存档配置之前，我们现在电脑上打开饥荒联机版游戏，进入主界面，点击下面的官网按钮，查看个人ID和个人服务器的token，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">个人ID: KU_uG******</span><br><span class="line">服务器token: pds-g^KU_uGVY9tdU^M***************************Sdsg50g4A6jg=</span><br></pre></td></tr></table></figure><p>此处应有图片… 10 11 12</p><p>饥荒默认存档位置在用户目录中.kiel文件夹中 (  ~/.kiel/DoNotStarveTogether)，由于我们在上面的启动命令中增加了-cluster参数，因此会在该文件夹中自动创建名为MyDediServer的存档文件夹，如果不指定该参数，则会自动生成Cluster_1的文件夹。由于饥荒服务器直接配置文件太过复杂，这里推荐使用存档替换的方式。</p><p>首先在个人电脑上启动游戏，创建一个新世界 ( 此处记住服务器栏位1~5 ) ，自定义自己的世界配置和Mod配置，启动世界后等到选人界面时退出</p><p>此处应有图片… 13</p><p>在游戏首页点击存档图标，进入本地存档目录，按照你刚才的栏位找到名为Cluster_[栏位]的文件夹，即为刚才创建的世界存档，复制当前文档路径，例如：F:\我的文档\Klei\DoNotStarveTogether\Cluster_1</p><p>此处应有图片… 14</p><p>打开Xftp工具，直接点击下图所示图标即可</p><p>此处应有图片… 15</p><p>左边为本地文件目录，右边为远程服务器文件目录</p><p>此处应有图片… 16</p><p>在左边粘贴刚才复制的文档路径，回车进入；右边输入服务器存档目录即 /home/steam/.klei/DoNotStarveTogether/MyDediServer，回车进入</p><p>此处应有图片… 17</p><p>文件对应说明：</p><p>① Master 文件夹为主世界即地面世界存档及配置</p><p>② Caves 文件夹为洞穴世界存档及配置</p><p>③ cluser.ini 文件为服务器信息，世界名称，密码等</p><p>④ cluster_token.txt 为服务器 token</p><p>⑤ Master 和 Caves 中共有的 : </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">backup -&gt; 服务器日志及聊天日志存档</span><br><span class="line">save -&gt;存档文件夹</span><br><span class="line">sever_chat_log.txt -&gt; 服务器此次启动中玩家的聊天内容</span><br><span class="line">server_log.txt -&gt; 服务器日志</span><br><span class="line">server.ini -&gt; 世界的配置信息，端口等</span><br><span class="line">leveldataoverride.lua-&gt;世界配置文件，即为世界详细配置，可以直接对其更改，来完成对世界的自定义</span><br><span class="line">modoverrides.lua -&gt; Mod配置文件，可以对其修改完成服务器Mod配置</span><br></pre></td></tr></table></figure><p>直接选中左侧所有文件及文件夹，拖拽至右侧，选择全部覆盖，等待文件全部传输至服务器即可关闭。然后再次回到Xshell窗口 ( 由于创建steam用户时没有增加密码，因此上传文件时默认使用的是root用户，此时需要先更改文件所有者 ) </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">chown -R steam:steam /home/steam </span><br><span class="line">su steam</span><br></pre></td></tr></table></figure><p>再进入存档文件夹，修改服务器token：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /home/steam/.klei/DoNotStarveTogether/MyDediServer</span><br><span class="line"><span class="meta">#</span> 编辑cluster_token.txt</span><br><span class="line">vim cluster_token.txt</span><br><span class="line"><span class="meta">#</span> 此时按i进入编辑模式，在文件中输入之前获取的服务器token</span><br><span class="line">pds-g^KU_uGVY9tdU^M***************************Sdsg50g4A6jg=</span><br><span class="line"><span class="meta">#</span> 编辑完成，按ESC，输入:wq 回车，即为保存并退出</span><br></pre></td></tr></table></figure><p>编辑管理员列表 ( 非必须 ) : </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 编辑adminlist.txt管理员列表，输入你想添加的玩家ID（类似于之前获取的个人ID）由于服务器token所有者默认拥有管理员权限，因此不需要添加自己的ID，此处仅做为参考</span><br><span class="line">vim adminlist.txt</span><br><span class="line"><span class="meta">#</span> 输入</span><br><span class="line">KU_uG******</span><br><span class="line"><span class="meta">#</span> 编辑完成，按ESC，输入:wq 回车，即为保存并退出</span><br></pre></td></tr></table></figure><p>编辑黑名单列表 ( 非必须 ) : </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim blocklist.txt</span><br><span class="line"><span class="meta">#</span> 输入黑名单玩家ID</span><br><span class="line">xxxxxxx</span><br><span class="line"><span class="meta">#</span> 编辑完成，按ESC，输入:wq 回车，即为保存并退出</span><br></pre></td></tr></table></figure><h4 id="6-MOD下载及使用"><a href="#6-MOD下载及使用" class="headerlink" title="6.MOD下载及使用"></a>6.MOD下载及使用</h4><p>Mod的配置文件即为上面所说的modoverrides.lua，使用编辑页面打开：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  [<span class="string">"workshop-1160616621"</span>]=&#123;</span><br><span class="line">    configuration_options=&#123; Language=<span class="string">"def"</span>, Ownership=<span class="literal">true</span>, Travel_Cost=<span class="number">32</span> &#125;,</span><br><span class="line">    enabled=<span class="literal">false</span> </span><br><span class="line">  &#125;,</span><br><span class="line">  [<span class="string">"workshop-1216718131"</span>]=&#123; configuration_options=&#123; clean=<span class="literal">true</span>, lang=<span class="literal">true</span>, stack=<span class="literal">true</span> &#125;, enabled=<span class="literal">true</span> &#125;,</span><br><span class="line">  [<span class="string">"workshop-362175979"</span>]=&#123; configuration_options=&#123; [<span class="string">"Draw over FoW"</span>]=<span class="string">"disabled"</span> &#125;, enabled=<span class="literal">true</span> &#125;,</span><br><span class="line">  [<span class="string">"workshop-378160973"</span>]=&#123;</span><br><span class="line">    configuration_options=&#123;</span><br><span class="line">     ENABLEPINGS=<span class="literal">true</span>,</span><br><span class="line">     FIREOPTIONS=<span class="number">2</span>,</span><br><span class="line">     OVERRIDEMODE=<span class="literal">false</span>,</span><br><span class="line">     SHAREMINIMAPPROGRESS=<span class="literal">true</span>,</span><br><span class="line">     SHOWFIREICONS=<span class="literal">true</span>,</span><br><span class="line">     SHOWPLAYERICONS=<span class="literal">true</span>,</span><br><span class="line">     SHOWPLAYERSOPTIONS=<span class="number">2</span> </span><br><span class="line">    &#125;,</span><br><span class="line">    enabled=<span class="literal">true</span> </span><br><span class="line">  &#125;,</span><br><span class="line">  [<span class="string">"workshop-703758203"</span>]=&#123; configuration_options=&#123;  &#125;, enabled=<span class="literal">true</span> &#125;,</span><br><span class="line">  [<span class="string">"workshop-804317397"</span>]=&#123;</span><br><span class="line">    configuration_options=&#123;</span><br><span class="line">      buffgo=<span class="literal">false</span>,</span><br><span class="line">      fhl_cos=<span class="number">0.05</span>,</span><br><span class="line">      fhl_hjopen=<span class="literal">false</span>,</span><br><span class="line">      likeornot=<span class="literal">false</span>,</span><br><span class="line">      openli=<span class="literal">false</span>,</span><br><span class="line">      openlight=<span class="literal">false</span>,</span><br><span class="line">      zzj_cankanshu=<span class="literal">false</span>,</span><br><span class="line">      zzj_canuseashammer=<span class="literal">false</span>,</span><br><span class="line">      zzj_canuseasshovel=<span class="literal">false</span>,</span><br><span class="line">      zzj_canwakuang=<span class="literal">false</span>,</span><br><span class="line">      zzj_finiteuses=<span class="number">210</span>,</span><br><span class="line">      zzj_fireopen=<span class="literal">false</span>,</span><br><span class="line">      zzj_pre=<span class="number">1</span> </span><br><span class="line">    &#125;,</span><br><span class="line">    enabled=<span class="literal">true</span> </span><br><span class="line">  &#125;,</span><br><span class="line"><span class="comment">--  Show Me</span></span><br><span class="line">  [<span class="string">"workshop-666155465"</span>]=&#123;</span><br><span class="line">    configuration_options=&#123; food_estimation=<span class="number">-1</span>, food_order=<span class="number">0</span>, food_style=<span class="number">0</span>, lang=<span class="string">"chs"</span>, show_food_units=<span class="number">-1</span> &#125;,</span><br><span class="line">    enabled=<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line"><span class="comment">--  复活</span></span><br><span class="line">  [<span class="string">"workshop-462434129"</span>]=&#123;</span><br><span class="line">    configuration_options=&#123;</span><br><span class="line">      MOD_RESTART_ALLOW_KILL=<span class="literal">false</span>,</span><br><span class="line">      MOD_RESTART_ALLOW_RESTART=<span class="literal">true</span>,</span><br><span class="line">      MOD_RESTART_ALLOW_RESURRECT=<span class="literal">true</span>,</span><br><span class="line">      MOD_RESTART_CD_KILL=<span class="number">100</span>,</span><br><span class="line">      MOD_RESTART_CD_RESTART=<span class="number">100</span>,</span><br><span class="line">      MOD_RESTART_CD_RESURRECT=<span class="number">100</span>,</span><br><span class="line">      MOD_RESTART_FORCE_DROP_MODE=<span class="number">1</span>,</span><br><span class="line">      MOD_RESTART_IGNORING_ADMIN=<span class="literal">true</span>,</span><br><span class="line">      MOD_RESTART_TRIGGER_MODE=<span class="number">1</span>,</span><br><span class="line">      MOD_RESTART_WELCOME_TIPS=<span class="literal">true</span>,</span><br><span class="line">      MOD_RESTART_WELCOME_TIPS_TIME=<span class="number">6</span> </span><br><span class="line">    &#125;,</span><br><span class="line">    enabled=<span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>workshop-[id] 此处ID即为创意工坊中连接的ID，可直接在创意工坊中查看；configuration_options配置选项同游戏中Mod配置相同，由于不清楚具体配置内容，不推荐手动修改。</p><p>那如何下载Mod呢？首先需要编辑文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim ~/dst/mods/dedicated_server_mods_setup.lua</span><br><span class="line"><span class="meta">#</span> 在文件中添加如下 : ( 括号中为 Mod 在创意工坊中的 id，内容按照自身服务器所需Mod填写 ) </span><br><span class="line">ServerModSetup("1216718131")</span><br><span class="line">ServerModSetup("375850593")</span><br><span class="line">ServerModSetup("378160973")</span><br><span class="line">ServerModSetup("458587300")</span><br><span class="line">ServerModSetup("703758203")</span><br><span class="line">ServerModSetup("804317397")</span><br><span class="line">ServerModSetup("1699254645")</span><br><span class="line"><span class="meta">#</span> 保存退出</span><br><span class="line"><span class="meta">#</span> PS:此处还可以直接输入Mod合集，即ServerModCollectionSetup("[id]")</span><br></pre></td></tr></table></figure><p>配置过之后，下次启动游戏时就会自动下载Mod并启用。</p><h4 id="7-启动游戏"><a href="#7-启动游戏" class="headerlink" title="7.启动游戏"></a>7.启动游戏</h4><p>可以直接启动 ( 推荐使用脚本 ) : </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ~/dst/bin</span><br><span class="line"><span class="meta">#</span> 启动地面世界</span><br><span class="line">./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Master</span><br><span class="line"><span class="meta">#</span> 启动洞穴世界</span><br><span class="line">./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Caves</span><br></pre></td></tr></table></figure><p>编写启动脚本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/dst_script</span><br><span class="line">cd ~/dst_script</span><br><span class="line">touch dst_master.sh</span><br><span class="line">touch dst_caves.sh</span><br><span class="line">chmod a+x dst_master.sh</span><br><span class="line">chmod a+x dst_caves.sh</span><br><span class="line"><span class="meta">#</span> 编辑标本</span><br><span class="line"></span><br><span class="line">vim dst_master.sh</span><br><span class="line"><span class="meta">#</span> 输入</span><br><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">cd ~/dst/bin</span><br><span class="line">screen -dmS "dst_overworld" ./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Master</span><br><span class="line"><span class="meta">#</span> 保存退出</span><br><span class="line"></span><br><span class="line">vim dst_caves.sh</span><br><span class="line"><span class="meta">#</span> 输入</span><br><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">cd ~/dst/bin</span><br><span class="line">screen -dmS "dst_caves" ./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Caves</span><br><span class="line"><span class="meta">#</span> 保存退出</span><br></pre></td></tr></table></figure><p>使用 <a href="https://www.cnblogs.com/lpfuture/p/5786843.html" target="_blank" rel="noopener">screen</a> -dmS 命令启动进程时，不会显示对应的控制台。如果需要使用控制台，则需要使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 恢复到地面世界进程</span><br><span class="line">screen -r dst_overworld</span><br><span class="line"><span class="meta">#</span> 隐藏控制台按下Ctrl+A然后按下Ctrl+D即可</span><br><span class="line"><span class="meta">#</span> 恢复到洞穴世界进程</span><br><span class="line">screen -r dst_caves</span><br><span class="line"><span class="meta">#</span> 隐藏控制台按下Ctrl+A然后按下Ctrl+D即可</span><br></pre></td></tr></table></figure><p>启动游戏，运行脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./dst_master.sh</span><br><span class="line">./dst_caves.sh</span><br></pre></td></tr></table></figure><p>等服务器启动后，即可在大厅搜索到对应服务器。</p><h4 id="8-关于更新"><a href="#8-关于更新" class="headerlink" title="8.关于更新"></a>8.关于更新</h4><p>编写更新脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch ~/dst_script/update.sh</span><br><span class="line">chmod a+x ~/dst_script/update.sh</span><br><span class="line">vim ~/dst_script/update.sh</span><br></pre></td></tr></table></figure><p>输入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>更新游戏</span><br><span class="line">~/steamcmd/steamcmd.sh +login anonymous +force_install_dir /home/steam/dst +app_update 343050 validate +quit</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>更新mod</span><br><span class="line">cd /home/steam/dst/bin</span><br><span class="line">~/dst/bin/dontstarve_dedicated_server_nullrenderer -only_update_server_mods</span><br></pre></td></tr></table></figure><p>执行时需要关闭服务器。</p><p>饥荒的游戏存档位置默认为 ~/.kiel/DoNotStarveTogether/中，上面我们启动命令中指定了-cluster的参数，游戏就会再上述文件夹中创建一个名为MyDediServer的文件夹，若不指定该参数，默认创建Cluster_1。</p>]]></content>
      
      
      <categories>
          
          <category> 游戏服务器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 饥荒 </tag>
            
            <tag> 专用服务器 </tag>
            
            <tag> Shell </tag>
            
            <tag> 阿里云 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生成Excel和CSV的工具类</title>
      <link href="/2019/01/21/%E7%94%9F%E6%88%90Excel%E5%92%8CCSV%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
      <url>/2019/01/21/%E7%94%9F%E6%88%90Excel%E5%92%8CCSV%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
      
        <content type="html"><![CDATA[<p>使用Java编写的生成Excel和CSV的工具类。</p><a id="more"></a><p>由于数据量过大时，生成Excel速度很慢，过程中内存占用量很大。因此当数据条数大于10000时，不支持生成Excel文件，并且使用CopyManager（postgresql中的工具）来生成CSV文件。</p><p>利用查询后的结果生成Excel和CSV文件的代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unicom.simpledemo.dao.UserDefinedSQLMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.CellStyle;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.HorizontalAlignment;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFCell;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFRow;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.streaming.SXSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.postgresql.copy.CopyManager;</span><br><span class="line"><span class="keyword">import</span> org.postgresql.core.BaseConnection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author by BayMin, Date on 2018/11/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String driverClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String dbUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String dbUserName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String dbPassword;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.datasource.druid.driver-class-name&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDriverClass</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        driverClass = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.datasource.druid.url&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDbUrl</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        dbUrl = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.datasource.druid.username&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDbUserName</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        dbUserName = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.datasource.druid.password&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDbPassword</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        dbPassword = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据查询结果生成Excel</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 生成的Excel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SXSSFWorkbook <span class="title">mapListToExcel</span><span class="params">(HttpSession session, UserDefinedSQLMapper userDefinedSQLMapper)</span> </span>&#123;</span><br><span class="line">        List&lt;LinkedHashMap&lt;String, Object&gt;&gt; linkedHashMaps = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> rows = (<span class="keyword">int</span>) session.getAttribute(<span class="string">"rows"</span>);</span><br><span class="line">        <span class="keyword">if</span> (rows &gt;= <span class="number">10000</span>) &#123;</span><br><span class="line">            log.error(<span class="string">"行数为"</span> + rows + <span class="string">"，不小于10000行，无法导出为Excel表格！"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        linkedHashMaps = (List&lt;LinkedHashMap&lt;String, Object&gt;&gt;) session.getAttribute(<span class="string">"linkedHashMaps"</span>);</span><br><span class="line">        log.info(<span class="string">"正在生成Excel表格..."</span>);</span><br><span class="line">        SXSSFWorkbook workbook = <span class="keyword">new</span> SXSSFWorkbook(<span class="number">100</span>);</span><br><span class="line">        SXSSFSheet sheet = workbook.createSheet(<span class="string">"result"</span>);</span><br><span class="line">        SXSSFRow row = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        CellStyle style = workbook.createCellStyle();</span><br><span class="line">        style.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        LinkedList&lt;String&gt; keys = (LinkedList&lt;String&gt;) session.getAttribute(<span class="string">"keys"</span>);</span><br><span class="line">        <span class="keyword">int</span> columnNum = keys.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnNum; i++) &#123;</span><br><span class="line">            SXSSFCell cell = row.createCell(i);</span><br><span class="line">            cell.setCellValue(keys.get(i));</span><br><span class="line">            cell.setCellStyle(style);</span><br><span class="line">            sheet.trackAllColumnsForAutoSizing();</span><br><span class="line">            sheet.autoSizeColumn(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; linkedHashMaps.size(); i++) &#123;</span><br><span class="line">            row = sheet.createRow(i + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (linkedHashMaps.get(i) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Iterator&lt;Map.Entry&lt;String, Object&gt;&gt; iterator = linkedHashMaps.get(i).entrySet().iterator();</span><br><span class="line">                <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    Map.Entry&lt;String, Object&gt; next = iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (next.getValue() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        row.createCell(j++).setCellValue(next.getValue().toString());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        row.createCell(j++).setCellValue(<span class="string">""</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                row.createCell(<span class="number">0</span>).setCellValue(<span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"生成Excel表格完成！"</span>);</span><br><span class="line">        <span class="keyword">return</span> workbook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出Excel</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workbook 需要导出的Excel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportExcel</span><span class="params">(HttpServletRequest request, HttpServletResponse response, SXSSFWorkbook workbook)</span> </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/vnd.ms-excel"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Content-disposition"</span>, <span class="string">"attachment;filename=Table-"</span> + Utils.parseDate(<span class="keyword">new</span> Date()) + <span class="string">".xlsx"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            OutputStream outputStream = response.getOutputStream();</span><br><span class="line">            workbook.write(outputStream);</span><br><span class="line">            outputStream.flush();</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出CSV文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session session(其中包含sql)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportCSV</span><span class="params">(HttpServletRequest request, HttpServletResponse response, HttpSession session)</span> </span>&#123;</span><br><span class="line">        LinkedList&lt;String&gt; keys = (LinkedList&lt;String&gt;) session.getAttribute(<span class="string">"keys"</span>);</span><br><span class="line">        StringBuilder tableHead = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (String str : keys) &#123;</span><br><span class="line">            tableHead.append(str).append(<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String headString = tableHead.substring(<span class="number">0</span>, tableHead.length() - <span class="number">1</span>);</span><br><span class="line">        headString = headString.concat(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.setContentType(<span class="string">"text/csv"</span>);</span><br><span class="line">            response.setHeader(<span class="string">"Content-disposition"</span>, <span class="string">"attachment;filename=Table-"</span> + Utils.parseDate(<span class="keyword">new</span> Date()) + <span class="string">".csv"</span>);</span><br><span class="line">            OutputStream outputStream = response.getOutputStream();</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">int</span>) session.getAttribute(<span class="string">"rows"</span>) &gt;= <span class="number">10000</span>) &#123;</span><br><span class="line">                exportCSVBySQL(request, response, session, headString, outputStream);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                exportCSVBySession(request, response, session, headString, outputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportCSVBySession</span><span class="params">(HttpServletRequest request, HttpServletResponse</span></span></span><br><span class="line"><span class="function"><span class="params">            response, HttpSession session, String headString, OutputStream outputStream)</span> </span>&#123;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder(headString);</span><br><span class="line">        String csv = <span class="string">""</span>;</span><br><span class="line">        List&lt;LinkedHashMap&lt;String, Object&gt;&gt; linkedHashMapsTop500 = (List&lt;LinkedHashMap&lt;String, Object&gt;&gt;) session.getAttribute(<span class="string">"linkedHashMaps"</span>);</span><br><span class="line">        <span class="keyword">for</span> (LinkedHashMap&lt;String, Object&gt; linkedHashMap : linkedHashMapsTop500) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; next : linkedHashMap.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (next.getValue() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    stringBuilder.append(next.getValue().toString());</span><br><span class="line">                &#125;</span><br><span class="line">                stringBuilder.append(<span class="string">","</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            stringBuilder.deleteCharAt(stringBuilder.length() - <span class="number">1</span>).append(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        csv = stringBuilder.substring(<span class="number">0</span>, stringBuilder.length() - <span class="number">1</span>);</span><br><span class="line">        outputStreamWrite(csv, outputStream);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportCSVBySQL</span><span class="params">(HttpServletRequest request, HttpServletResponse response, HttpSession</span></span></span><br><span class="line"><span class="function"><span class="params">            session, String headString, OutputStream outputStream)</span> </span>&#123;</span><br><span class="line">        outputStreamWrite(headString, outputStream);</span><br><span class="line">        String sql = session.getAttribute(<span class="string">"sql"</span>).toString();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(driverClass);</span><br><span class="line">            Connection connection = DriverManager.getConnection(dbUrl, dbUserName, dbPassword);</span><br><span class="line">            CopyManager copyManager = <span class="keyword">new</span> CopyManager((BaseConnection) connection);</span><br><span class="line">            copyManager.copyOut(<span class="string">"copy ("</span> + sql + <span class="string">") to stdout with csv"</span>, outputStream);</span><br><span class="line">            outputStream.flush();</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"使用COPY命令导出CSV文件出错，当前SQL为："</span> + sql);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">outputStreamWrite</span><span class="params">(String info, OutputStream outputStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = info.getBytes();</span><br><span class="line">        InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((len = inputStream.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                outputStream.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                outputStream.flush();</span><br><span class="line">            &#125;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 工具类 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Greenplum数据库迁移</title>
      <link href="/2018/12/12/Greenplum%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/"/>
      <url>/2018/12/12/Greenplum%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/</url>
      
        <content type="html"><![CDATA[<p>由于之前的数据库使用年限过久，机器性能无法满足日常计算需要，因此公司最近新购入了若干服务器，并准备将数据迁移至新库中。在正式迁移之前，通过查阅相关资料，进行一次模拟迁移。</p><a id="more"></a><h4 id="1-准备"><a href="#1-准备" class="headerlink" title="1.准备"></a>1.准备</h4><p>① VMware Workstation软件</p><p>② CentOS 7.3 镜像 ( 与老服务器相同 )</p><p>③ Greenplum 4.3.7.3 安装包 ( <a href="https://network.pivotal.io/products/pivotal-gpdb/" target="_blank" rel="noopener">https://network.pivotal.io/products/pivotal-gpdb/</a> )</p><h4 id="2-安装虚拟机"><a href="#2-安装虚拟机" class="headerlink" title="2.安装虚拟机"></a>2.安装虚拟机</h4><p>修改时区，最小安装：</p><p><img src="https://img.vim-cn.com/bc/2bd07b48aa9868a53351be1e2f3eadefe17a65.png" alt></p><p>添加root用户密码：</p><p><img src="https://img.vim-cn.com/e2/6844fd5ab076e93eb004d2405345e0ca0f37f8.png" alt></p><p>安装完成后，修改IP地址：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/netword-scripts/ifcfg-eno***</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">PEERDNS=yes</span><br><span class="line">PEERROUTES=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_PEERDNS=yes</span><br><span class="line">IPV6_PEERROUTES=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">NAME=eno16777736</span><br><span class="line">UUID=5bed79bf-0f21-40fe-a92c-63aa29d0dbdd</span><br><span class="line">DEVICE=eno16777736</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.216.128</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.216.2</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">DNS2=8.8.8.8</span><br></pre></td></tr></table></figure><p>重启network服务，并使用ping测试是否可以连接到外网：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service network restart</span><br></pre></td></tr></table></figure><p>安装一些需要的工具：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vim net-tools ntp ed unzip</span><br></pre></td></tr></table></figure><p>设置开机时间同步脚本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rc.d/init.d/timelock.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>Startup script for timelock</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>chkconfig:345 85 15</span><br><span class="line"><span class="meta">#</span>description:timelock server</span><br><span class="line"><span class="meta">#</span>processname:timelock</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span>Source function library.</span><br><span class="line">/usr/sbin/ntpdate -u ntp1.aliyun.com</span><br></pre></td></tr></table></figure><p>增加脚本的可执行权限并添加到开机启动项目中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x  /etc/rc.d/init.d/autostart.sh</span><br><span class="line">cd /etc/rc.d/init.d</span><br><span class="line">chkconfig --add autostart.sh</span><br><span class="line">chkconfig autostart.sh on</span><br></pre></td></tr></table></figure><p>修改系统内核 ( Greenplum需要 )：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc.sysctl.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kernel.shmmax = 500000000</span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">kernel.shmall = 4000000000</span><br><span class="line">kernel.sem = 250 512000 100 2048</span><br><span class="line">kernel.sysrq = 1</span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.msgmni = 2048</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.ip_forward = 0</span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 4096</span><br><span class="line">net.ipv4.conf.all.arp_filter = 1</span><br><span class="line">net.ipv4.ip_local_port_range = 1025 65535</span><br><span class="line">net.core.netdev_max_backlog = 10000</span><br><span class="line">net.core.rmem_max = 2097152</span><br><span class="line">net.core.wmem_max = 209715</span><br></pre></td></tr></table></figure><p>打开文件限制 : ( 在最后添加 )</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/security/limits.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 131072</span><br><span class="line">* hard nproc 131072</span><br></pre></td></tr></table></figure><p>创建gpadmin用户和用户组 ( 每台都需要配置 ) ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd -g 530 gpadmin</span><br><span class="line">useradd -g 530 -u530 -m -d /home/gpadmin -s /bin/bash gpadmin</span><br><span class="line">passwd gpadmin</span><br></pre></td></tr></table></figure><p>关闭防火墙：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure><h4 id="3-拷贝两份虚拟机"><a href="#3-拷贝两份虚拟机" class="headerlink" title="3.拷贝两份虚拟机"></a>3.拷贝两份虚拟机</h4><p>分别修改IP、hostname，配置hosts</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.216.128 Master master</span><br><span class="line">192.168.216.129 sdw1</span><br><span class="line">192.168.216.130 sdw2</span><br><span class="line"> </span><br><span class="line">192.168.216.138 Master_standby master_standby gp_master_standby</span><br><span class="line">192.168.216.139 sdw1_standby segment_standby segment</span><br><span class="line">192.168.216.140 sdw2_standby mirror_standby mirror</span><br></pre></td></tr></table></figure><p>重启，准备安装数据库。</p><h4 id="4-安装数据库"><a href="#4-安装数据库" class="headerlink" title="4.安装数据库"></a>4.安装数据库</h4><p>首先在Master节点上操作：</p><p>​    切换用户gpadmin，解压下载的数据库文件并运行greenplum-db-*.bin安装文件 ( 安装过程中注意数据库安装位置 )</p><p><img src="https://img.vim-cn.com/3b/1912bbe9d46419b8f264ba46582b81e2c6e0c2.png" alt></p><p>创建配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir ./conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/hostlist</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Master_standby</span><br><span class="line">sdw1_standby</span><br><span class="line">sdw2_standby</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/set_host</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdw1_standby</span><br><span class="line">sdw2_standby</span><br></pre></td></tr></table></figure><p>引入Greenplum的环境变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ./greenplum-db-4.3.7.3/greenplum_path.sh</span><br></pre></td></tr></table></figure><p>交换钥匙：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpssh-exkeys -f ./conf/hostlist</span><br></pre></td></tr></table></figure><p>PS：</p><p>一个小问题 <code>socket.gaierror: [Errno -2] Name or service not known</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">原因 hosts 里没有配置 hostname 中的 IP</span><br></pre></td></tr></table></figure><p>开始安装数据库：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpseginstall -f hostlist -u gpadmin -p 123456</span><br></pre></td></tr></table></figure><fancybox><img src="https://img.vim-cn.com/d5/7b15f39363f657e38b027309b3539c66a209d8.png" alt></fancybox><p>在不同节点上创建数据目录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>gp_master_standby:</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpmaster</span><br><span class="line"><span class="meta">#</span>sdw1_standby:</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdata1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap2</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam2</span><br><span class="line"><span class="meta">#</span>sdw2_standby</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpmaster</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatap2</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam1</span><br><span class="line">mkdir -p /home/gpadmin/gpdata/gpdatam2</span><br></pre></td></tr></table></figure><p>检查系统环境：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>错误暂且不管 ( 好像并没有影响 )</span><br><span class="line">gpcheck -f ./conf/hostlist -m Master_standby -s sdw2_standby</span><br></pre></td></tr></table></figure><p>编写初始化文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>数据库代号</span><br><span class="line">ARRAY_NAME="EMC Greenplum DW"</span><br><span class="line">MACHINE_LIST_FILE=/home/gpadmin/conf/seg_hosts</span><br><span class="line"><span class="meta">#</span>Segment 的名称前缀</span><br><span class="line">SEG_PREFIX=gpseg</span><br><span class="line"><span class="meta">#</span>primary segment 起始端口号</span><br><span class="line">PORT_BASE=40000</span><br><span class="line"><span class="meta">#</span>指定 primary segment 的数据目录</span><br><span class="line">declare -a DATA_DIRECTORY=(/home/gpadmin/gpdata/gpdatap1 /home/gpadmin/gpdata/gpdatap2)</span><br><span class="line">MASTER_HOSTNAME=gp_master_standby</span><br><span class="line">MASTER_DIRECTORY=/home/gpadmin/gpdata/gpmaster</span><br><span class="line">MASTER_DATA_DIRECTORY=/home/gpadmin/gpdata/gpmaster</span><br><span class="line">MASTER_PORT=5432</span><br><span class="line"><span class="meta">#</span>指定 bash 的版本</span><br><span class="line">TRUSTED_SHELL=ssh</span><br><span class="line"><span class="meta">#</span>mirror segment 起始端口号</span><br><span class="line">MIRROR_PORT_BASE=50000</span><br><span class="line"><span class="meta">#</span>primary segment 主备同步的起始端口号</span><br><span class="line">REPLICATION_PORT_BASE=41000</span><br><span class="line"><span class="meta">#</span>mirror segment 主备同步的起始端口号</span><br><span class="line">MIRROR_REPLICATION_PORT_BASE=51000</span><br><span class="line"><span class="meta">#</span>mirror segment 的数据目录</span><br><span class="line">declare -a MIRROR_DATA_DIRECTORY=(/home/gpadmin/gpdata/gpdatam1 /home/gpadmin/gpdata/gpdatam2)</span><br></pre></td></tr></table></figure><p>初始化数据库：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpinitsystem -c ./conf/gp_init_config -s sdw2_standby</span><br></pre></td></tr></table></figure><p>启动数据库 : </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpstart -a</span><br></pre></td></tr></table></figure><p>至此，数据库安装完毕，准备迁移数据。</p><h4 id="5-迁移数据库"><a href="#5-迁移数据库" class="headerlink" title="5.迁移数据库"></a>5.迁移数据库</h4><p>Greenplum数据库迁移可以使用官方自带工具gptransfer进行迁移，具体使用方法参照官网  ( <a href="https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html" target="_blank" rel="noopener">https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html</a>)</p><p>修改源数据库中配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/gpadmin/gpdata/gpmaster/gpseg-1/pg_hba.conf</span><br></pre></td></tr></table></figure><p>添加如下 ( IP范围为192.168.216.1 - 192.168.216.254 ) ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host     all     all     192.168.216.1/24    md5</span><br></pre></td></tr></table></figure><p>在源数据库中重新加载配置文件：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_reload_conf()</span><br></pre></td></tr></table></figure><p>准备打通目标数据库与源数据库之间的通道，创建映射文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/transferlist</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdw1,192.168.216.129</span><br><span class="line">sdw2,192.168.216.130</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./conf/transhost</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sdw2_standby</span><br><span class="line">sdw1_standby</span><br><span class="line">master</span><br><span class="line">sdw1</span><br><span class="line">sdw2</span><br></pre></td></tr></table></figure><p>交换钥匙：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpssh-exkeys -f /home/gpadmin/conf/transhost</span><br></pre></td></tr></table></figure><p>开始迁移数据：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/gpadmin/greenplum-db-4.3.7.3/bin//gptransfer --source-map-file=/home/gpadmin/conf/transferlist --dest-host=192.168.216.128 --full</span><br></pre></td></tr></table></figure><fancybox><img src="https://img.vim-cn.com/0e/a93306672759c753ca0429f483430b24f8d431.png" alt></fancybox><p>迁移完毕：</p><fancybox><img src="https://img.vim-cn.com/cc/57fcbcb9ebcf4983d5170a979b7d212554b875.png" alt></fancybox><p>将源数据库中的配置文件postgresql.conf和pg_hba.conf发送至目标数据库中，重启目标数据库。</p><p>至此数据库迁移完毕。</p><h4 id="参考网址"><a href="#参考网址" class="headerlink" title="参考网址"></a>参考网址</h4><p>① <a href="https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html" target="_blank" rel="noopener">https://gp-docs-cn.github.io/docs/best_practices/gptransfer.html</a></p><p>② <a href="https://www.cnblogs.com/liuyungao/p/5689588.html" target="_blank" rel="noopener">https://www.cnblogs.com/liuyungao/p/5689588.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Greenplum </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Greenplum </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 数据迁移 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Greenplum查看数据库和表所占磁盘大小</title>
      <link href="/2018/12/05/Greenplum%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8%E6%89%80%E5%8D%A0%E7%A3%81%E7%9B%98%E5%A4%A7%E5%B0%8F/"/>
      <url>/2018/12/05/Greenplum%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8%E6%89%80%E5%8D%A0%E7%A3%81%E7%9B%98%E5%A4%A7%E5%B0%8F/</url>
      
        <content type="html"><![CDATA[<p>查看数据库所占磁盘大小的几条命令。</p><a id="more"></a><p>表的大小 : </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_size_pretty(pg_relation_size(<span class="string">'gp_test'</span>));</span><br><span class="line"> pg_size_pretty </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line"> 1761 MB</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><p>表和索引的大小 : </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_size_pretty(pg_total_relation_size(<span class="string">'gp_test'</span>));</span><br><span class="line"> pg_size_pretty </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line"> 2186 MB</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><p>查看指定数据库大小 : </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_size_pretty(pg_database_size(<span class="string">'zwcdb'</span>));</span><br><span class="line"> pg_size_pretty </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line"> 2241 MB</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><p>查看所有数据库的大小 : </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> datname,pg_size_pretty(pg_database_size(datname)) <span class="keyword">from</span> pg_database;</span><br><span class="line">  datname  | pg_size_pretty </span><br><span class="line"><span class="comment">-----------+----------------</span></span><br><span class="line"> zwcdb     | 2241 MB</span><br><span class="line"> postgres  | 47 MB</span><br><span class="line"> template1 | 47 MB</span><br><span class="line"> template0 | 45 MB</span><br><span class="line"> gpperfmon | 67 MB</span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure><p>查看数据分布情况和磁盘空间 : </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> gp_segment_id,<span class="keyword">count</span>(*) <span class="keyword">from</span> gp_test <span class="keyword">group</span> <span class="keyword">by</span> gp_segment_id <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br><span class="line"> gp_segment_id |  count  </span><br><span class="line"><span class="comment">---------------+---------</span></span><br><span class="line">             0 | 5000000</span><br><span class="line">             1 | 4999999</span><br><span class="line">             2 | 5000001</span><br><span class="line">             3 | 5000000</span><br><span class="line">(4 rows)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">select</span> dfhostname, dfspace,dfdevice <span class="keyword">from</span> gp_toolkit.gp_disk_free <span class="keyword">order</span> <span class="keyword">by</span> dfhostname;</span><br><span class="line"> dfhostname | dfspace  |  dfdevice  </span><br><span class="line"><span class="comment">------------+----------+------------</span></span><br><span class="line">  sdw1      | 12273372 |  /dev/sdb1</span><br><span class="line">  sdw1      | 12273372 |  /dev/sdb1</span><br><span class="line">  sdw2      | 12273404 |  /dev/sdb1</span><br><span class="line">  sdw2      | 12273404 |  /dev/sdb1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Greenplum </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Greenplum </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
